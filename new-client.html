<link rel="stylesheet" href="datepicker/css/bootstrap-datepicker3.standalone.min.css">
<link rel="stylesheet" href="css/style.css">
<script type="text/javascript" src="datepicker/js/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="datepicker/locales/bootstrap-datepicker.es.min.js"></script>


<div class="container-fluid mt-3">
    <div class="card">
        <div class="card-header custom-header-card text-center">
            <h5 id="module-client-title">Información del Cliente</h5>
        </div>
        <div class="card-body">
            <form class="text-center needs-validation" data-toggle="validator" novalidate id="frm-client">
                <input type="hidden" name="activo" id="hid-active">
                <div class="md-form  input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">INE</span>
                    </div>
                    <input type="text" class="form-control" placeholder="Ingrese INE a validar" aria-label="INE"
                        name="ine" id="txt-ine" aria-describedby="btn-val-ine" maxlength="15" required
                        data-editable="0">
                    <div class="invalid-feedback" id="divInvalidINE">
                        Indique número de INE.
                    </div>
                    <div class="input-group-append">
                        <button class="btn btn-md btn-secondary m-0 px-3 py-2 z-depth-0 waves-effect" type="button"
                            id="btn-val-ine" disabled>Validar INE</button>
                    </div>
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Número de Cliente</span>
                    </div>
                    <input type="number" name="id" id="txt-id" maxlength="11" aria-label="Id" class="form-control"
                        placeholder="Id" required readonly>
                    <input type="number" name="numero" id="txt-number" maxlength="11" aria-label="Interno"
                        class="form-control" placeholder="Interno" required data-editable="0">
                    <input type="text" name="idExterno" id="txt-external-id" maxlength="50" aria-label="Id Externo"
                        class="form-control" placeholder="Id Externo" data-editable="0">
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Nombre Completo</span>
                    </div>
                    <input type="text" name="nombre" id="txt-first-name" maxlength="50" aria-label="Nombre"
                        class="form-control" placeholder="Nombre" required>
                    <input type="text" name="apellidoPaterno" id="txt-last-name" maxlength="50"
                        aria-label="Apellido Paterno" class="form-control" placeholder="Apellido Paterno" required>
                    <input type="text" name="apellidoMaterno" id="txt-second-last-name" maxlength="50"
                        aria-label="Apellido Materno" class="form-control" placeholder="Apellido Materno">
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Direccion</span>
                    </div>
                    <input type="text" name="calle" id="txt-street" maxlength="100" aria-label="Calle"
                        class="form-control" placeholder="Calle" required>
                    <input type="text" name="numeroExt" id="txt-num-ext" maxlength="10" aria-label="Número Ext."
                        class="form-control" placeholder="Número Ext." required>
                    <input type="text" name="numInt" id="txt-num-int" maxlength="5" aria-label="Número Int."
                        class="form-control" placeholder="Número Int.">
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Colonia y CP </span>
                    </div>
                    <input type="text" name="colonia" id="txt-neighbor" maxlength="100" aria-label="Colonia"
                        class="form-control" placeholder="Colonia" required>
                    <input type="text" name="zona" id="txt-zone" maxlength="100" aria-label="Zona" class="form-control"
                        placeholder="Zona" required>
                    <input type="number" name="cp" id="txt-cp" maxlength="10" aria-label="CP" class="form-control"
                        placeholder="00000" required>
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon" md-addon>Localización</span>
                    </div>
                    <input type="text" name="estado" id="txt-state" maxlength="100" aria-label="Estado"
                        class="form-control" placeholder="Estado" required>
                    <input type="text" name="municipio" id="txt-town" maxlength="100" aria-label="Municipio"
                        class="form-control" placeholder="Municipio" required>
                    <input type="text" name="ciudad" id="txt-city" maxlength="100" aria-label="Ciudad"
                        class="form-control" placeholder="Ciudad" required>
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Teléfonos</span>
                    </div>
                    <input type="tel" name="telCasa" id="txt-home" maxlength="20" aria-label="Casa" class="form-control"
                        placeholder="Casa">
                    <input type="tel" name="movil1" id="txt-mobile-1" maxlength="20" aria-label="Móvil 1"
                        class="form-control" placeholder="Móvil 1" required>
                    <input type="tel" name="movil2" id="txt-mobile-2" maxlength="20" aria-label="Móvil 2"
                        class="form-control" placeholder="Móvil 2">
                    <input type="tel" name="movil3" id="txt-mobile-3" maxlength="20" aria-label="Móvil 3"
                        class="form-control" placeholder="Móvil 3">
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Correo y Redes Sociales</span>
                    </div>
                    <input type="email" name="correoElectronico" id="txt-email" maxlength="100"
                        aria-label="Correo Electrónico" class="form-control" placeholder="correo@gmail.com">
                    <input type="text" name="facebook" id="txt-facebook" maxlength="100" aria-label="Facebook"
                        class="form-control" placeholder="Facebook">

                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Fecha de Alta</span>
                    </div>
                    <input placeholder="Selecciona la Fecha de Alta" type="text" id="txt-record-date"
                        class="form-control" name="fechaAlta" required>
                </div>
                <div class="md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Estatus del Cliente</span>
                    </div>
                    <input type="text" id="txt-active" aria-label="Estatus del Cliente" class="form-control"
                        data-editable="0" name="activo">

                </div>
                <div class=" md-form input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text md-addon">Historial</span>
                    </div>
                    <input type="text" name="fechaCreacion" id="txt-created-on" aria-label="Fecha de Creación"
                        class="form-control" placeholder="Fecha de Creación" data-editable="0">
                    <input type="text" name="fechaModificacion" id="txt-updated-on" aria-label="Última de Modificación"
                        class="form-control" placeholder="Última de Modificación" data-editable="0">
                </div>
                <div class="text-center">
                    <button type="buttton" class="btn btn-primary" id="btn-save"><i
                            class="fas fa-cloud mr-1"></i>Guardar</button>
                    <!-- <button type="button" class="btn btn-primary action-button" id="btn-new-client"
                        data-page="new-client"><i class="fas fa-user-plus"></i> Agregar
                        Cliente</button>-->
                    <button type="button" class="btn btn-secondary"><i class="fas fa-undo mr-1"></i>Revertir
                        Cambios</button>
                    <button type="button" class="btn btn-primary" disabled data-client-exists="0"><i
                            class="fas fa-user-minus mr-1"></i>Dar de
                        Baja</button>
                    <button type="button" class="btn btn-primary action-button" id="btn-add-voucher" disabled
                        data-client-exists="0" data-page="list-client-vouchers"><i class="fas fa-money-check-alt"></i>
                        Ver Vales</button>
                    <button type="button" class="btn btn-primary action-button" id="btn-view-statement" disabled
                        data-client-exists="0"><i class="fas fa-file-invoice"></i>
                        Ver Pagos</button>
                    <button type="button" class="btn btn-primary action-button" data-page="list-clients"><i
                            class="fas fa-users mr-1"></i>Ir a Listado de
                        Clientes</button>
                </div>
            </form>
        </div>
        <div class="row mt-5">

        </div>
    </div>
    <script type="text/javascript">
        var clientAction = "";
        //var clientId = localStorage.getItem("currentClientId");
        console.log(getClientId());
        $(".action-button").on("click", function () {
            loadModule(this);
        });

        $('#txt-record-date').datepicker({
            todayBtn: "linked",
            clearBtn: true,
            language: "es",
            format: "dd-mm-yyyy"
        });

        if (getClientId() !== null) {
            clientAction = "edit";
            $("input[data-editable='0']").attr("readonly", true);
            $("button[data-client-exists='0']").attr("disabled", false);
            var jqXHR = findClientById(parseInt(getClientId())).done(createEditDoneHandler).fail(createEditFailHandler);
            if (jqXHR.status != 200) {
                showAlert("BHermanos", jqXHR.responseText, "error");
            }
        } else {
            clientAction = "create";
            $('#txt-record-date').datepicker('setDate', new Date());
            $("#hid-active").val("Y");
            $("#txt-active").val("Activo");
        }

        $("#btn-save").on("click", function (event) {
            event.preventDefault();
            var form = document.getElementById("frm-client");
            var isValidForm = form.checkValidity();
            form.classList.add('was-validated');
            console.log(isValidForm);

            if (isValidForm) {
                var postdata = serializeForm(form);
                console.log(postdata);
                //var jqXHR;
                switch (clientAction) {
                    case "create":
                        var jqXHR = createClient(postdata).done(createEditDoneHandler).fail(createEditFailHandler);
                        if (jqXHR.status == 200) {
                            $("input[data-editable='0']").attr("readonly", true);
                            $("button[data-client-exists='0']").attr("disabled", false);
                            showAlert("BHermanos", "Cliente registrado exitósamente", "success");
                            localStorage.setItem("currentClientId", postdata.id);
                        } else {
                            showAlert("BHermanos", jqXHR.responseText, "error");
                        }
                        console.log("jqXHR");
                        console.log(jqXHR);
                        clientAction = "edit";
                        break;
                    case "edit":
                        var id = parseInt(getClientId());
                        var jqXHR = updateClient(id, postdata).done(createEditDoneHandler).fail(createEditFailHandler);
                        if (jqXHR.status == 200) {
                            //$("input[data-editable='0']").attr("disabled", true);
                            showAlert("BHermanos", "Cliente actualizado exitósamente", "success");
                        } else {
                            showAlert("BHermanos", jqXHR.responseText, "error");
                        }
                        console.log("jqXHR");
                        console.log(jqXHR);
                        break;
                    default:
                }
            } else {
                showAlert("BHermanos", "Capture todos los datos mandatorios", "error");
            }
        });



        $("#txt-ine").on("change", function () {
            var active = $(this).val().trim().length === 0;
            $("#btn-val-ine").attr("disabled", active);
        });

        $("#btn-val-ine").on("click", function () {
            var jqXHR = checkINE($("#txt-ine").val()).done(function (data, textStatus, jqXHR) {
                console.log(textStatus);
                showAlert("BHermanos", "INE disponible para registrar cliente", "info");

            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.responseText);
                console.log(errorThrown);
                showAlert("BHermanos", jqXHR.responseText, "error");
            });
        });

        /*function fillClientForm(data) {
            $.each(data, function (key, val) {
                $("input[name='" + key + "']").val(val);
                console.log(key);
                if (key === "activo") {
                    var active = "Inactivo";
                    if (val === "Y") {
                        active = "Activo"
                    }

                    $("#txt-active").val(active);
                }
            });
            $('.datepicker').datepicker('update', data.fechaAlta);
        }*/

        function createEditDoneHandler(data, textStatus, jqXHR) {
            console.log(data);
            fillClientForm(data, "frm-client");
        }

        function createEditFailHandler(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
            console.log(errorThrown);
        }



    </script>